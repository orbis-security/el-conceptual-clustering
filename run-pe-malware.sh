#! /bin/bash

function die() {
	echo $@ >&2
	exit 1
}

if [ $# -lt 4 ]; then
    die "Usage: $0 MAX_DEPTH MAX_ITERATIONS TIMEOUT_MINUTES SAMPLE_SIZE [DATASET_NUMBER...]"
fi

MAX_DEPTH=$1
MAX_ITERATIONS=$2
TIMEOUT=$(($3*60))
SIZE=$4
shift 4

BASE_PATH="./pe-malware-ontology" # No / at the end!
ONTO_BASE="$BASE_PATH/$SIZE"
RESULTS_BASE="$BASE_PATH-results-$MAX_DEPTH-$MAX_ITERATIONS/$SIZE"

[ -d "$ONTO_BASE" ] || die "Error: $ONTO_BASE does not exist"

DATASETS=()
if [ $# -gt 0 ]; then
	DATASETS=("$@")
else
	DATASETS=($(ls "$ONTO_BASE"))
fi

mkdir -p "$RESULTS_BASE"

for ont_num in "${DATASETS[@]}"
do
    ont="dataset_${ont_num}_$SIZE.owl"
    ont_path="$ONTO_BASE/$ont_num/$ont"

    echo $ont

    rm output.owl clustering-result.owl || true
    /usr/bin/time -f "TOTAL TIME: %e" \
        timeout $TIMEOUT \
        ./computeHierarchy.sh "$ont_path" $MAX_DEPTH $MAX_ITERATIONS \
        &> "$RESULTS_BASE/$ont.log"
    mv output.owl "$RESULTS_BASE/$ont.simGraph.owl"
    mv clustering-result.owl "$RESULTS_BASE/$ont.clustering.owl"
done
